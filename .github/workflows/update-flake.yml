badges:
  runs-on: ubuntu-latest
  needs: update

  steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - uses: cachix/install-nix-action@v24

    - name: Get current date
      id: date
      run: echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT

    - name: Build system and get size
      id: size
      run: |
        nix build .#defaultPackage.x86_64-linux -o result
        size_bytes=$(nix path-info -S ./result | cut -f2 -d' ')
        size_mb=$(echo "scale=1; $size_bytes / 1024 / 1024" | bc)
        echo "size=${size_mb}MB" >> $GITHUB_OUTPUT

    - name: Write badge JSON files
      run: |
        mkdir -p badges
        echo "{
          \"schemaVersion\": 1,
          \"label\": \"last flake update\",
          \"message\": \"${{ steps.date.outputs.date }}\",
          \"color\": \"green\"
        }" > badges/last-update.json

        echo "{
          \"schemaVersion\": 1,
          \"label\": \"system size\",
          \"message\": \"${{ steps.size.outputs.size }}\",
          \"color\": \"blue\"
        }" > badges/system-size.json

    - name: Commit and push badges
      run: |
        git config user.name "danerieberbot"
        git config user.email "danebot@proton.me"
        git add badges/*.json
        git commit -m "chore: update dynamic badges 🏷️" || echo "No badge changes"
        git push
