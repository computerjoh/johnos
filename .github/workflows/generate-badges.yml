name: Generate Badges

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  badges:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: cachix/install-nix-action@v24

      - name: Get current date
        id: date
        run: echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Write badge JSON files
        run: |
          mkdir -p badges
          echo "{
            \"schemaVersion\": 1,
            \"label\": \"last flake update\",
            \"message\": \"${{ steps.date.outputs.date }}\",
            \"color\": \"green\"
          }" > badges/last-update.json

      - name: Commit and push badges
        run: |
          git config user.name "danerieberbot"
          git config user.email "danebot@proton.me"
          git add badges/*.json
          git commit -m "chore: update dynamic badges 🏷️" || echo "No badge changes"
          git push
